#!/bin/zsh
# tmux-select - Global tmux session selector
# Usage: ts

show_menu() {
    sessions=$(tmux ls 2>/dev/null)

    clear
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  üñ•Ô∏è  Tmux Session Manager"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""

    if [[ -z "$sessions" ]]; then
        echo " No active sessions."
        echo ""
        echo " Create a session:"
        echo " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "   c-kommu    c-devlens   c-formation"
        echo "   c-dent     c-gluten    c-resonant"
        echo "   c-life     c-saga      c-vision"
        echo "   c-agentik  c-home"
        echo ""
        return 1
    fi

    echo " Active sessions:"
    echo " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

    declare -g -a sess_names
    declare -g -a project_bases
    sess_names=()
    project_bases=()
    i=1
    while IFS= read -r line; do
        name=$(echo "$line" | cut -d: -f1)
        sess_names+=("$name")
        # Extract base project name (e.g., "Home-2" -> "Home", "DentistryGPT" -> "DentistryGPT")
        base_name="${name%%-[0-9]*}"
        if [[ ! " ${project_bases[*]} " =~ " ${base_name} " ]]; then
            project_bases+=("$base_name")
        fi
        wins=$(tmux list-windows -t "$name" 2>/dev/null | wc -l)
        path=$(tmux display-message -t "$name" -p '#{pane_current_path}' 2>/dev/null | sed "s|$HOME|~|")
        created=$(tmux display-message -t "$name" -p '#{session_created}' 2>/dev/null)
        if [[ -n "$created" ]]; then
            created_fmt=$(date -d "@$created" "+%d/%m %H:%M" 2>/dev/null || echo "")
        else
            created_fmt=""
        fi
        printf "   %d) %-15s ‚îÇ %d win ‚îÇ %s ‚îÇ %s\n" "$i" "$name" "$wins" "$created_fmt" "$path"
        ((i++))
    done <<< "$sessions"

    echo ""
    echo " Actions:"
    echo " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo "   D) üóëÔ∏è  Delete a session"
    echo "   F) üéØ Delete by project (all Home, all Dent...)"
    echo "   K) üíÄ Delete ALL sessions"
    echo "   C) üßπ Clean RAM & caches (safe, keeps Claude data)"
    echo "   X) ‚ò¢Ô∏è  NUCLEAR (kill sessions + clean caches)"
    echo "   R) üîÑ Refresh"
    echo "   Q) ‚ùå Quit"
    echo ""
    echo -n " ‚û§ "
    return 0
}

while true; do
    show_menu
    menu_result=$?

    if [[ $menu_result -eq 1 ]]; then
        exit 0
    fi

    # Read input with proper terminal handling
    read -r choice 2>/dev/null || choice=""
    # Remove any control characters and trim
    choice=$(echo "$choice" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    choice_lower="${choice:l}"

    case "$choice_lower" in
        [1-9])
            idx=$((choice_lower))
            if [[ $idx -le ${#sess_names[@]} ]]; then
                sess="${sess_names[$idx]}"
                echo ""
                echo "üîó Attaching to $sess..."
                sleep 0.3
                tmux attach -t "$sess"
                exit 0
            else
                echo " ‚ùå Invalid choice"
                sleep 1
            fi
            ;;
        d|d\ [1-9]|d[1-9])
            # Extract number if provided directly
            if [[ "$choice_lower" =~ ^d\ ?([0-9]+)$ ]]; then
                del_choice="${match[1]}"
            else
                echo ""
                echo " Which session to delete? (1-${#sess_names[@]})"
                echo -n " ‚û§ "
                read -r del_choice
            fi

            if [[ "$del_choice" =~ ^[0-9]+$ ]] && [[ $del_choice -le ${#sess_names[@]} ]] && [[ $del_choice -ge 1 ]]; then
                sess="${sess_names[$del_choice]}"
                tmux kill-session -t "$sess" 2>/dev/null
                echo " ‚úì Session $sess deleted"
                sleep 1
            else
                echo " ‚ùå Invalid choice"
                sleep 1
            fi
            ;;
        f)
            echo ""
            echo " üéØ Kill sessions by project"
            echo " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo ""
            # Show available projects with session counts
            j=1
            declare -a project_list
            project_list=()
            for proj in "${project_bases[@]}"; do
                count=$(tmux ls 2>/dev/null | grep -cE "^${proj}(-[0-9]+)?:")
                project_list+=("$proj")
                printf "   %d) %-15s (%d session%s)\n" "$j" "$proj" "$count" "$([[ $count -gt 1 ]] && echo 's' || echo '')"
                ((j++))
            done
            echo ""
            echo "   A) ‚ùå Cancel"
            echo ""
            echo -n " ‚û§ "
            read -r proj_choice
            proj_choice_lower="${proj_choice:l}"

            if [[ "$proj_choice_lower" == "a" || -z "$proj_choice" ]]; then
                echo " Cancelled."
                sleep 1
            elif [[ "$proj_choice" =~ ^[0-9]+$ ]] && [[ $proj_choice -le ${#project_list[@]} ]] && [[ $proj_choice -ge 1 ]]; then
                selected_proj="${project_list[$proj_choice]}"
                # Count sessions for this project
                proj_sessions=($(tmux ls 2>/dev/null | grep -E "^${selected_proj}(-[0-9]+)?:" | cut -d: -f1))
                echo ""
                echo " ‚ö†Ô∏è  Delete ALL ${#proj_sessions[@]} ${selected_proj} session(s)? (y/n)"
                echo -n " ‚û§ "
                read -r confirm
                if [[ "${confirm:l}" == "y" || "${confirm:l}" == "yes" ]]; then
                    for s in "${proj_sessions[@]}"; do
                        tmux kill-session -t "$s" 2>/dev/null
                        echo " ‚úì $s deleted"
                    done
                    echo ""
                    echo " ‚úÖ All ${selected_proj} sessions deleted!"
                    sleep 1
                else
                    echo " Cancelled."
                    sleep 1
                fi
            else
                echo " ‚ùå Invalid choice"
                sleep 1
            fi
            ;;
        k)
            echo ""
            echo " ‚ö†Ô∏è  Delete ALL sessions? (y/n)"
            echo -n " ‚û§ "
            read -r confirm
            confirm_lower="${confirm:l}"
            if [[ "$confirm_lower" == "y" || "$confirm_lower" == "yes" ]]; then
                tmux kill-server 2>/dev/null
                echo " ‚úì All sessions deleted"
                sleep 1
                exit 0
            else
                echo " Cancelled."
                sleep 1
            fi
            ;;
        c)
            echo ""
            echo " üßπ System cleanup..."
            echo " ‚ö†Ô∏è  SAFE: Keeps ~/.claude/ (conversations, history, config)"
            echo ""

            # RAM before
            ram_before=$(free -m | awk '/^Mem:/{print $3}')

            # Kill orphan node processes (not attached to tmux)
            zombies=$(pgrep -f "node" | while read pid; do
                if ! tmux list-panes -a -F '#{pane_pid}' 2>/dev/null | grep -q "^$pid$"; then
                    parent=$(ps -o ppid= -p $pid 2>/dev/null | tr -d ' ')
                    if [[ "$parent" == "1" ]]; then
                        echo $pid
                    fi
                fi
            done)
            if [[ -n "$zombies" ]]; then
                echo "$zombies" | xargs kill -9 2>/dev/null
                echo " ‚úì Orphan node processes killed"
            fi

            # Clear global npm/bun caches
            npm cache clean --force 2>/dev/null && echo " ‚úì npm cache cleaned"
            bun pm cache rm 2>/dev/null && echo " ‚úì bun cache cleaned"

            # Drop system caches (requires sudo)
            sync
            echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null 2>&1 && echo " ‚úì RAM freed (drop_caches)"

            # RAM after
            ram_after=$(free -m | awk '/^Mem:/{print $3}')
            ram_freed=$((ram_before - ram_after))

            echo ""
            echo " üìä Result:"
            free -h | awk '/^Mem:/{printf "    RAM: %s used / %s total\n", $3, $2}'
            if [[ $ram_freed -gt 0 ]]; then
                echo "    Freed: ${ram_freed}MB"
            fi
            df -h / | tail -1 | awk '{print "    Disk: "$3" / "$2" ("$5")"}'
            echo ""
            echo " üõ°Ô∏è  PRESERVED: ~/.claude/ (all conversations & config)"
            echo ""
            sleep 3
            ;;
        x|kkc)
            echo ""
            echo " ‚ò¢Ô∏è  NUCLEAR - Delete ALL sessions + clean caches? (y/n)"
            echo " üõ°Ô∏è  SAFE: ~/.claude/ will NOT be touched"
            echo -n " ‚û§ "
            read -r confirm
            confirm_lower="${confirm:l}"
            if [[ "$confirm_lower" == "y" || "$confirm_lower" == "yes" ]]; then
                echo ""
                echo " üíÄ Killing ALL tmux sessions..."
                tmux kill-server 2>/dev/null
                echo " ‚úì All sessions deleted"

                echo ""
                echo " üßπ Cleaning system..."
                ram_before=$(free -m | awk '/^Mem:/{print $3}')

                # Kill orphan node processes
                zombies=$(pgrep -f "node" | while read pid; do
                    parent=$(ps -o ppid= -p $pid 2>/dev/null | tr -d ' ')
                    if [[ "$parent" == "1" ]]; then
                        echo $pid
                    fi
                done)
                if [[ -n "$zombies" ]]; then
                    echo "$zombies" | xargs kill -9 2>/dev/null
                    echo " ‚úì Orphan node processes killed"
                fi

                # Clear caches
                npm cache clean --force 2>/dev/null && echo " ‚úì npm cache cleaned"
                bun pm cache rm 2>/dev/null && echo " ‚úì bun cache cleaned"

                # Drop RAM
                sync
                echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null 2>&1 && echo " ‚úì RAM freed"

                ram_after=$(free -m | awk '/^Mem:/{print $3}')
                ram_freed=$((ram_before - ram_after))

                echo ""
                echo " ‚ò¢Ô∏è  NUCLEAR complete!"
                echo " üìä Result:"
                free -h | awk '/^Mem:/{printf "    RAM: %s used / %s total\n", $3, $2}'
                [[ $ram_freed -gt 0 ]] && echo "    Freed: ${ram_freed}MB"
                df -h / | tail -1 | awk '{print "    Disk: "$3" / "$2" ("$5")"}'
                echo ""
                sleep 2
                exit 0
            else
                echo " Cancelled."
                sleep 1
            fi
            ;;
        r)
            # Refresh - loop will redisplay
            ;;
        q|"")
            echo " Bye!"
            exit 0
            ;;
        *)
            echo " ‚ùå Invalid choice"
            sleep 1
            ;;
    esac
done
