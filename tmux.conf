# tmux configuration - DafnckStudio/AgentikOS
# Ultra-minimal theme - NO backgrounds, fonts only

# Status bar: transparent background (terminal default)
set -g status-style bg=default,fg='#888888'

# Fenêtre active (pas de BG)
setw -g window-status-current-style bg=default,fg='#FFFFFF',bold

# Fenêtre inactive (pas de BG)
setw -g window-status-style bg=default,fg='#555555'

# Bordures des panes - très subtiles
set -g pane-border-style fg='#333333'
set -g pane-active-border-style fg='#666666',bg=default

# Message bar - minimal
set -g message-style bg=default,fg='#FFFFFF',bold

# Mode
setw -g mode-style bg='#333333',fg='#FFFFFF'

# Clock
setw -g clock-mode-colour '#888888'

# Status bar position
set -g status-position bottom

# Rafraîchir la status bar toutes les 2 secondes
set -g status-interval 2

# Status bar format
set -g status-left-length 60
set -g status-right-length 120

# Left side: time + session + git branch + BG tasks
set -g status-left ' #[fg=#c96442]%H:%M #[fg=#333333]· #[fg=#666666]#S #[fg=#333333]· #[fg=#c96442]#(~/.tmux/scripts/git-branch.sh) #[fg=#333333]· #[fg=#666666]BG #[fg=#c96442]#(~/.tmux/scripts/bg-tasks.sh) #[fg=#333333]·'

# Right side: Ralph + tunnel + sessions + metrics + push
set -g status-right '#[fg=#50fa7b]#(~/.tmux/scripts/ralph-status.sh)#[fg=#333333]#{?#{!=:#(~/.tmux/scripts/ralph-status.sh),}, · ,}#[fg=#666666]Tunnel #[fg=#c96442]#(~/.tmux/scripts/tunnel-status.sh) #[fg=#333333]· #[fg=#666666]TS #[fg=#c96442]#(~/.tmux/scripts/sessions-count.sh) #[fg=#333333]· #[fg=#666666]RAM #[fg=#c96442]#(~/.tmux/scripts/ram-usage.sh) #[fg=#333333]· #[fg=#666666]CPU #[fg=#c96442]#(~/.tmux/scripts/cpu-usage.sh) #[fg=#333333]· #[fg=#666666]Disk #[fg=#c96442]#(~/.tmux/scripts/disk-usage.sh) #[fg=#333333]· #[fg=#666666]Push #[fg=#c96442]#(~/.tmux/scripts/last-push.sh) '

# Window status format (masqué - on n'affiche pas les noms de fenêtres)
setw -g window-status-format ''
setw -g window-status-current-format ''

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# ====== NOTIFICATION BELL (for Claude responses) ======
# Pass bell through to terminal (will beep on Mac)
set -g bell-action any
set -g visual-bell off
# This passes the \a character through SSH to your Mac terminal

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable mouse support
set -g mouse on

# Increase scrollback buffer
set -g history-limit 10000

# Faster command sequences
set -s escape-time 10

# Terminal colors
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# ====== FIXES POUR LONG PROCESSES ======

# NE PAS détacher quand une fenêtre se termine
set -g detach-on-destroy off

# Les fenêtres restent ouvertes après la fin du process
setw -g remain-on-exit on

# Désactiver les timeouts automatiques
set -g display-time 0

# Pas de timeout sur les commandes
set -g repeat-time 0

# Session persiste même si déconnecté
set -g destroy-unattached off

# ====== PLUGINS (TPM) ======

# Chemin des plugins
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.tmux/plugins/'

# Plugin manager
set -g @plugin 'tmux-plugins/tpm'

# Better mouse mode - scroll plus fluide
set -g @plugin 'nhdaly/tmux-better-mouse-mode'

# Configuration du scroll
set -g @scroll-speed-num-lines-per-scroll 5
set -g @scroll-down-exit-copy-mode "on"
set -g @scroll-without-changing-pane "on"
set -g @emulate-scroll-for-no-mouse-alternate-buffer "on"

# Initialiser TPM
run '~/.tmux/plugins/tpm/tpm'

# ====== OVERRIDE APRÈS PLUGIN : Inverser le scroll ======
# Ces bindings s'appliquent APRÈS le plugin pour inverser le sens

bind -T copy-mode WheelUpPane send-keys -X scroll-down \; send-keys -X scroll-down \; send-keys -X scroll-down \; send-keys -X scroll-down \; send-keys -X scroll-down
bind -T copy-mode WheelDownPane send-keys -X scroll-up \; send-keys -X scroll-up \; send-keys -X scroll-up \; send-keys -X scroll-up \; send-keys -X scroll-up
bind -T copy-mode-vi WheelUpPane send-keys -X scroll-down \; send-keys -X scroll-down \; send-keys -X scroll-down \; send-keys -X scroll-down \; send-keys -X scroll-down
bind -T copy-mode-vi WheelDownPane send-keys -X scroll-up \; send-keys -X scroll-up \; send-keys -X scroll-up \; send-keys -X scroll-up \; send-keys -X scroll-up

# === Claude Notifications ===
# Notification après 5 secondes de silence (Claude a fini)
set-option -g monitor-silence 5

# Hook qui s'exécute quand silence détecté
set-hook -g alert-silence 'run-shell "curl -s -H \"Title: Claude terminé\" -d \"✅ Réponse terminée (#{session_name})\" ntfy.sh/gluten-libre-vps-claude > /dev/null 2>&1 &"'

# Visual bell désactivé (on utilise ntfy)
set-option -g visual-silence off

# ====== SESSION & WINDOW SWITCHING (Option/Alt keys) ======
# Option+Z - Liste interactive COMPLÈTE (sessions + fenêtres)
bind -n M-z choose-tree

# Option+X - Session précédente
bind -n M-x switch-client -p

# Option+V - Session suivante
bind -n M-v switch-client -n

# Option+B - Dernière session utilisée
bind -n M-b switch-client -l

# Option+W - Liste des fenêtres (session courante)
bind -n M-w choose-window

# Option+A - Fenêtre précédente (dans la session)
bind -n M-a previous-window

# Option+S - Fenêtre suivante (dans la session)
bind -n M-s next-window

# Option+Q - Dernière fenêtre utilisée
bind -n M-q last-window

# Option+K - Kill session courante (avec confirmation)
bind -n M-k confirm-before -p "Kill session #S? (y/n)" kill-session

# Option+D - Fermer fenêtre courante (avec confirmation)
bind -n M-d confirm-before -p "Kill window #W? (y/n)" kill-window

# Option+N - Nouvelle fenêtre
bind -n M-n new-window -c "#{pane_current_path}"

# Option+R - Renommer la session
bind -n M-r command-prompt -I "#S" "rename-session '%%'"

# Option+T - Renommer la fenêtre
bind -n M-t command-prompt -I "#W" "rename-window '%%'"

# Option+F - Zoom/Fullscreen le pane (toggle)
bind -n M-f resize-pane -Z

# Option+H - Split horizontal
bind -n M-h split-window -h -c "#{pane_current_path}"

# Option+J - Split vertical
bind -n M-j split-window -v -c "#{pane_current_path}"

# Option+C - Copier le mode (scroll + sélection)
bind -n M-c copy-mode

# ====== RALPH INTEGRATION ======
# Ctrl+b r - Launch Ralph in a new window (same session)
bind r run-shell '~/.tmux/scripts/ralph-launch.sh'

# Ctrl+b R - Switch to Ralph window (or back to Claude)
bind R run-shell '~/.tmux/scripts/ralph-switch.sh'

# Ctrl+b K - Kill Ralph window
bind K run-shell '~/.tmux/scripts/ralph-kill.sh'
